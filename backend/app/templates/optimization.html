{% extends "base.html" %}

{% block title %}Optimization - OptimaPricer{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Price Optimization</h1>
            <p class="text-slate-500 mt-1">AI-powered pricing recommendations based on market data</p>
        </div>
    </div>

    <div id="recommendationsContainer" class="space-y-4">
        <!-- Recommendations will be loaded here -->
    </div>
</div>

<script>
// Store chart instances globally
const chartInstances = {};

async function loadRecommendations() {
    try {
        const response = await fetch('/api/recommendations', { credentials: 'include' });
        const recommendations = await response.json();
        
        const container = document.getElementById('recommendationsContainer');
        
        if (recommendations.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center">
                    <svg class="w-16 h-16 mx-auto text-slate-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h2 class="text-lg font-semibold text-slate-900 mb-2">No recommendations yet</h2>
                    <p class="text-slate-600 mb-6">Scan your products to get price optimization recommendations</p>
                    <a href="/products" class="inline-block bg-emerald-900 hover:bg-emerald-800 text-white font-medium py-2.5 px-5 rounded-lg">
                        Go to Products →
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = recommendations.map(rec => {
            const product = rec.product;
            const priceDiff = rec.suggestedPrice - product.currentPrice;
            const priceDiffPercent = ((priceDiff / product.currentPrice) * 100).toFixed(1);
            const isIncrease = priceDiff > 0;
            const matchesMarket = rec.marketAveragePrice && Math.abs(rec.suggestedPrice - rec.marketAveragePrice) < 0.01;
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between gap-6">
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-slate-900">${product.name}</h2>
                                    <p class="text-sm text-slate-500 mt-1">${product.sku} • ${product.category}</p>
                                </div>
                                ${matchesMarket ? `
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Matches Market
                                    </span>
                                ` : ''}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <div class="text-xs text-slate-600 uppercase tracking-wide mb-1">Current Price</div>
                                    <div class="text-2xl font-bold text-slate-900">$${product.currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <div class="text-xs text-slate-600 uppercase tracking-wide mb-1">
                                        Market Average${rec.marketPriceCount ? ` (${rec.marketPriceCount})` : ''}
                                    </div>
                                    <div class="text-2xl font-bold text-blue-600">
                                        ${rec.marketAveragePrice ? '$' + rec.marketAveragePrice.toFixed(2) : 'N/A'}
                                    </div>
                                </div>
                                <div class="${isIncrease ? 'bg-emerald-50' : 'bg-amber-50'} rounded-lg p-4">
                                    <div class="text-xs text-slate-600 uppercase tracking-wide mb-1">Suggested Price</div>
                                    <div class="text-2xl font-bold ${isIncrease ? 'text-emerald-600' : 'text-amber-600'}">
                                        $${rec.suggestedPrice.toFixed(2)}
                                    </div>
                                    <div class="text-xs ${isIncrease ? 'text-emerald-600' : 'text-amber-600'} mt-1">
                                        ${isIncrease ? '+' : ''}${priceDiffPercent}%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 rounded-lg p-4 mb-4">
                                <div class="text-sm font-medium text-slate-900 mb-2">${rec.rationale}</div>
                                <div class="flex items-center gap-4 text-xs text-slate-600">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        ${rec.confidenceScore}% confidence
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        ${rec.riskLevel} risk
                                    </span>
                                    <span class="text-slate-600">${rec.strategy}</span>
                                </div>
                            </div>
                            
                            <!-- Price Impact Curve -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border border-blue-100">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <h3 class="text-sm font-semibold text-slate-900 mb-1">Price Impact on Sales</h3>
                                        <p class="text-xs text-slate-600">See how changing your price affects expected sales volume</p>
                                    </div>
                                    <button onclick="toggleElasticityCurve('${rec.id}')" 
                                        class="text-xs text-blue-700 hover:text-blue-800 font-medium flex items-center gap-1">
                                        <span id="curve-toggle-text-${rec.id}">Show</span>
                                        <svg id="curve-toggle-icon-${rec.id}" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div id="elasticity-curve-${rec.id}" class="hidden">
                                    <canvas id="elasticity-chart-${rec.id}" class="w-full" style="max-height: 300px;"></canvas>
                                    <div id="elasticity-info-${rec.id}" class="mt-3 text-xs text-slate-600">
                                        <!-- Info will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col gap-2 min-w-[120px]">
                            <button onclick="applyRecommendation('${rec.id}', ${rec.suggestedPrice})"
                                class="bg-emerald-900 hover:bg-emerald-800 text-white font-medium py-2.5 px-4 rounded-lg whitespace-nowrap transition-colors">
                                Apply
                            </button>
                            <button onclick="rejectRecommendation('${rec.id}')"
                                class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-lg whitespace-nowrap transition-colors">
                                Reject
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Don't load elasticity curves immediately - they'll load when user clicks "Show"
        // This improves page load performance
    } catch (error) {
        if (window.logError) window.logError('Error loading recommendations:', error);
    }
}

// Toggle elasticity curve visibility
function toggleElasticityCurve(recId) {
    const curveDiv = document.getElementById(`elasticity-curve-${recId}`);
    const toggleText = document.getElementById(`curve-toggle-text-${recId}`);
    const toggleIcon = document.getElementById(`curve-toggle-icon-${recId}`);
    
    if (curveDiv.classList.contains('hidden')) {
        curveDiv.classList.remove('hidden');
        toggleText.textContent = 'Hide';
        toggleIcon.style.transform = 'rotate(180deg)';
        // Load curve if not already loaded
        if (!chartInstances[recId]) {
            loadElasticityCurve(recId);
        }
    } else {
        curveDiv.classList.add('hidden');
        toggleText.textContent = 'Show';
        toggleIcon.style.transform = 'rotate(0deg)';
    }
}

// Load and render elasticity curve
async function loadElasticityCurve(recId) {
    // Check if chart already exists and is loaded
    if (chartInstances[recId] && chartInstances[recId]._loaded) {
        return; // Already loaded, don't reload
    }
    
    const canvas = document.getElementById(`elasticity-chart-${recId}`);
    const infoDiv = document.getElementById(`elasticity-info-${recId}`);
    
    if (!canvas) {
        return; // Chart container might be hidden
    }
    
    // Show loading state
    if (infoDiv) {
        infoDiv.innerHTML = `
            <div class="text-center py-2">
                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                <p class="text-xs text-slate-500 mt-1">Loading...</p>
            </div>
        `;
    }
    
    try {
        const response = await fetch(`/api/recommendations/${recId}/elasticity`, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch elasticity data');
        }
        
        const data = await response.json();
        
        // Destroy existing chart if it exists
        if (chartInstances[recId]) {
            chartInstances[recId].destroy();
            delete chartInstances[recId];
        }
        
        if (typeof Chart === 'undefined') {
            if (window.logError) window.logError('Chart.js is not available');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // Extract data points
        const prices = data.curve.map(point => point.price);
        const demands = data.curve.map(point => point.demand);
        
        // Find closest indices for current and suggested prices
        let currentPriceIndex = -1;
        let suggestedPriceIndex = -1;
        let minCurrentDiff = Infinity;
        let minSuggestedDiff = Infinity;
        
        prices.forEach((p, i) => {
            const currentDiff = Math.abs(p - data.currentPrice);
            const suggestedDiff = Math.abs(p - data.suggestedPrice);
            if (currentDiff < minCurrentDiff) {
                minCurrentDiff = currentDiff;
                currentPriceIndex = i;
            }
            if (suggestedDiff < minSuggestedDiff) {
                minSuggestedDiff = suggestedDiff;
                suggestedPriceIndex = i;
            }
        });
        
        // Create arrays for marker points
        const currentPriceData = Array(prices.length).fill(null);
        const suggestedPriceData = Array(prices.length).fill(null);
        
        if (currentPriceIndex >= 0) {
            currentPriceData[currentPriceIndex] = data.currentDemand;
        }
        if (suggestedPriceIndex >= 0) {
            suggestedPriceData[suggestedPriceIndex] = data.suggestedDemand;
        }
        
        // Create chart
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: prices.map(p => `$${p.toFixed(2)}`),
                datasets: [
                    {
                        label: 'Expected Sales',
                        data: demands,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Current Price',
                        data: currentPriceData,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false,
                        pointStyle: 'circle'
                    },
                    {
                        label: 'Suggested Price',
                        data: suggestedPriceData,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false,
                        pointStyle: 'circle'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `Price: ${context[0].label}`;
                            },
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return `Expected Sales: ${context.parsed.y.toFixed(1)}${data.baseDemand >= 10 ? ' units' : '%'}`;
                                } else if (context.datasetIndex === 1) {
                                    return `Current: ${data.currentDemand.toFixed(1)}${data.baseDemand >= 10 ? ' units' : '%'} sales`;
                                } else {
                                    return `Suggested: ${data.suggestedDemand.toFixed(1)}${data.baseDemand >= 10 ? ' units' : '%'} sales`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: data.baseDemand >= 10 ? 'Expected Sales (units)' : 'Expected Sales (%)',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: 'rgb(71, 85, 105)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: 'rgb(71, 85, 105)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Price ($)',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: 'rgb(71, 85, 105)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            color: 'rgb(71, 85, 105)',
                            maxRotation: 45,
                            minRotation: 45,
                            callback: function(value, index) {
                                // Show every 4th label to avoid crowding
                                return index % 4 === 0 ? this.getLabelForValue(value) : '';
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Store chart instance and mark as loaded
        chartInstances[recId] = chart;
        chartInstances[recId]._loaded = true;
        
        // Update info text
        const demandChangeText = data.demandChange >= 0 ? 
            `+${data.demandChange.toFixed(1)}` : 
            data.demandChange.toFixed(1);
        const demandChangeColor = data.demandChange >= 0 ? 'text-emerald-600' : 'text-amber-600';
        
        infoDiv.innerHTML = `
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded p-2">
                    <div class="text-xs text-slate-500 mb-1">At Current Price</div>
                    <div class="text-sm font-semibold text-slate-900">$${data.currentPrice.toFixed(2)}</div>
                    <div class="text-xs text-slate-600 mt-1">${data.currentDemand.toFixed(1)}${data.baseDemand >= 10 ? ' units' : '%'} expected sales</div>
                </div>
                <div class="bg-white rounded p-2">
                    <div class="text-xs text-slate-500 mb-1">At Suggested Price</div>
                    <div class="text-sm font-semibold text-slate-900">$${data.suggestedPrice.toFixed(2)}</div>
                    <div class="text-xs text-slate-600 mt-1">${data.suggestedDemand.toFixed(1)}${data.baseDemand >= 10 ? ' units' : '%'} expected sales</div>
                </div>
            </div>
            <div class="mt-3 p-2 bg-white rounded">
                <div class="text-xs text-slate-500 mb-1">Expected Change in Sales</div>
                <div class="text-sm font-semibold ${demandChangeColor}">
                    ${demandChangeText}${data.baseDemand >= 10 ? ' units' : '%'} (${data.demandChangePercent >= 0 ? '+' : ''}${data.demandChangePercent.toFixed(1)}%)
                </div>
                <div class="text-xs text-slate-500 mt-1">
                    ${data.demandChange >= 0 ? 
                        'Higher price may reduce sales volume, but could increase total revenue' : 
                        'Lower price may increase sales volume, potentially boosting total revenue'}
                </div>
            </div>
        `;
        
    } catch (error) {
        if (window.logError) window.logError('Error loading elasticity curve:', error);
        const infoDiv = document.getElementById(`elasticity-info-${recId}`);
        if (infoDiv) {
            infoDiv.innerHTML = `
                <div class="text-center py-2 text-xs text-red-600">
                    Unable to load price impact data
                </div>
            `;
        }
    }
}


async function applyRecommendation(recId, price) {
    const confirmed = await customConfirm(
        `Apply this recommendation and update the product price to $${price.toFixed(2)}?`,
        'Apply Price Recommendation'
    );
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/recommendations/${recId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'applied', applyPrice: true })
        });
        
        if (response.ok) {
            await customAlert(`Price updated successfully to $${price.toFixed(2)}`, 'Success', 'success', true, 1000);
            loadRecommendations();
        } else {
            await customAlert('Failed to apply recommendation. Please try again.', 'Error', 'error');
        }
    } catch (error) {
        if (window.logError) window.logError('Error applying recommendation:', error);
        await customAlert('An error occurred while applying the recommendation.', 'Error', 'error');
    }
}

async function rejectRecommendation(recId) {
    const confirmed = await customConfirm(
        'Are you sure you want to reject this recommendation?',
        'Reject Recommendation'
    );
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/recommendations/${recId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'rejected' })
        });
        
        if (response.ok) {
            loadRecommendations();
        } else {
            await customAlert('Failed to reject recommendation. Please try again.', 'Error', 'error');
        }
    } catch (error) {
        if (window.logError) window.logError('Error rejecting recommendation:', error);
        await customAlert('An error occurred while rejecting the recommendation.', 'Error', 'error');
    }
}

loadRecommendations();
</script>
{% endblock %}
